<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: white;
    }
    .center {
      margin: auto;
      width: 50%;
    }
  </style>
</head>
<body>
  <div class="center" id="regressionPlot" style="width:1224px;height:800px;"></div>

  <script>
    // Load JSON file
    fetch("Entrega 1/popularidad.json")
      .then(response => response.json())
      .then(data => {
        // Nota: hay que desactivar la cache en "Network" en DevTools para que recargue el JSON
        console.log(data);
        // Extract variables
        const labels = data.map(d => d.genero);
        const x = data.map(d => d.proporcion);
        const y = data.map(d => d.popularidad);
        const r = data.map(d => d.residuos);

        const minVal = Math.min(...r);
        const maxVal = Math.max(...r);
        // f^-1 de f(x) = min + x * (max - min)
        const zeroPos = (0 - minVal) / (maxVal - minVal);

        // --- Traces ---

        // Regression line
        const maxval = Math.max(...y);
        const lineX = [0, maxval];
        const lineY = lineX;

        const regressionLine = {
          x: lineX,
          y: lineY,
          mode: 'lines',
          type: 'scatter',
          name: 'Regression Line',
          line: { color: 'black' }
        };

        // Residual lollipops (vertical segments)
        function colorScale(val, minVal, maxVal, zeroPos) {
          const t = (val - minVal) / (maxVal - minVal); // normalize 0..1
          if (t <= zeroPos) {
            // interpolate red → gray
            const alpha = t / zeroPos;
            return `rgb(${255 * (1 - alpha) + 128 * alpha},${0 + 128 * alpha},${0 + 128 * alpha})`;
          } else {
            // interpolate gray → blue
            const alpha = (t - zeroPos) / (1 - zeroPos);
            return `rgb(${128 * (1 - alpha)},${128 * (1 - alpha)},${128 + 127 * alpha})`;
          }
        }

        // Scatter points
        const points = x.map((d,i) => {
          return {
            x: [x[i]],
            y: [y[i]],
            mode: 'markers',
            type: 'scatter',
            name: 'Observed',
            marker: {
              size: 5 + Math.abs(r[i])*100/2,
              color: colorScale(r[i], minVal, maxVal, zeroPos)
            },
            showlegend: false // avoid repeating "Observed" in legend
          };
        });

        // Generate one trace per residual
        const residualSegments = x.map((d,i) => ({
          x: [x[i], x[i]],
          y: [y[i], x[i]], // start at actual y, end at fitted value
          mode: 'lines',
          type: 'scatter',
          line: {
            width: 2,
            color: colorScale(r[i], minVal, maxVal, zeroPos)
          },
          showlegend: false,
          hoverinfo: 'skip'
        }));

        const color_action = colorScale(r[0], minVal, maxVal, zeroPos);
        const color_kids = colorScale(r[5], minVal, maxVal, zeroPos);
        const color_harem = colorScale(r[6], minVal, maxVal, zeroPos);

        const action_label = `<b>Action</b> (<span style="color:${color_action};">+${r[0].toFixed(2)*100}%</span>)`;
        const kids_label = `<b>Kids</b> (<span style="color:${color_kids};">${r[5].toFixed(2)*100}%</span>)`;
        const harem_label = `<b>Harem</b> (<span style="color:${color_harem};">${r[6].toFixed(2)*100}%</span>)`;

        const layout = {
          xaxis: {
            showgrid: false,
            tickformat: ',.0%',
            range: [0, maxval+0.01],
            tickvals: [0.05, 0.10, 0.15, 0.20, 0.25, 0.3]
          },
          yaxis: {
            showgrid: false,
            tickformat: ',.0%',
            range: [0, maxval+0.01],
            tickvals: [0.05, 0.10, 0.15, 0.20, 0.25, 0.3]
          },
          annotations: [
            { // TITULO
              text: "Oferta y demanda en géneros de anime:<br>¿qué tan alineados están?",
              font: { size: 36, color: "black", family: "Roboto" },
              xref: 'paper',
              yref: 'paper',
              x: 0.5,
              y: 1.17,
              showarrow: false,
              xanchor: "center",
              yanchor: "bottom",
            },
            { // SUB-TITULO
              text: 'Action destaca por una demanda muy superior a su oferta,<br>\
mientras que Kids y Harem sobresalen por un exceso de oferta frente a su demanda.',
              xref: 'paper',
              yref: 'paper',
              x: 0.5,     // center horizontally
              y: 1.07,    // slightly below the title
              showarrow: false,
              xanchor: "center",
              yanchor: "bottom",
              font: {size: 16, color: 'gray'}
            },
            { // ESQUINA SUPERIOR IZQUIERDA
              text: "Mayor demanda<br>que oferta",
              xref: "paper",
              yref: "paper",
              x: 0.1,   // near left
              y: 0.85,   // near top
              showarrow: false,
              font: { size: 24, color: "blue", family: "Roboto" }
            },
            { // ESQUINA INFERIOR DERECHA
              text: "Mayor oferta<br>que demanda<br> ",
              xref: "paper",
              yref: "paper",
              x: 0.9,   // near right
              y: 0.29,   // near bottom
              xanchor: "right",
              yanchor: "bottom",
              showarrow: false,
              font: { size: 24, color: "red", family: "Roboto" }
            },
            { // EJE Y
              text: "<b>Demanda de animes por género</b>",
              xref: "paper",
              yref: "paper",
              x: -0.105,
              y: 1.04,
              xanchor: "left",
              yanchor: "center",
              font: { family: "Roboto", size: 14, color: "rgb(10,10,10)" },
              showarrow: false,
            },
            { // EJE X
              text: "<b>Oferta de animes por género</b>",
              xref: "paper",
              yref: "paper",
              x: 0.5,
              y: -0.05,
              xanchor: "center",
              yanchor: "top",
              font: { family: "Roboto", size: 14, color: "rgb(10,10,10)" },
              showarrow: false,
            },{ // DIAGONAL
              x: 0.235,
              y: 0.247,
              text: "<b>Oferta = Demanda</b>",
              showarrow: false,
              textangle: -30,
              font: { size: 15 },
            },
            { // FLECHITA ACTION
              x: 0.167,               // the point you want to point to
              y: 0.329,
              xref: 'x',          // use 'x'/'y' for data coordinates
              yref: 'y',
              showarrow: true,    // enables the arrow
              arrowhead: 3,       // style of the arrow
              arrowsize: 1,       // size of the arrow
              ax: 90,             // x-offset of text relative to point
              ay: 20,            // y-offset of text relative to point
              text: action_label,  // label text
              font: {
                family: "Roboto",
                size: 25,
                color: "rgb(10,10,10)"
              },
              xanchor: "left",
              yanchor: "center",
              arrowcolor: 'black'
            },{ // FLECHITA KIDS  
              x: 0.145,               // the point you want to point to
              y: 0.0188,
              xref: 'x',          // use 'x'/'y' for data coordinates
              yref: 'y',
              showarrow: true,    // enables the arrow
              arrowhead: 3,       // style of the arrow
              arrowsize: 1,       // size of the arrow
              ax: -90,             // x-offset of text relative to point
              ay: -0,            // y-offset of text relative to point
              text: kids_label,  // label text
              font: {
                family: "Roboto",
                size: 25,
                color: "rgb(10,10,10)"
              },
              xanchor: "right",
              yanchor: "center",
              arrowcolor: 'black'
            },{ // FLECHITA HAREM
              x: 0.203,               // the point you want to point to
              y: 0.012,
              xref: 'x',          // use 'x'/'y' for data coordinates
              yref: 'y',
              showarrow: true,    // enables the arrow
              arrowhead: 3,       // style of the arrow
              arrowsize: 1,       // size of the arrow
              ax: 62,             // x-offset of text relative to point
              ay: -12,            // y-offset of text relative to point
              text: harem_label,  // label text
              font: {
                family: "Roboto",
                size: 25,
                color: "rgb(10,10,10)"
              },
              xanchor: "left",
              yanchor: "center",
              arrowcolor: 'black'
            },
            
          ],
          showlegend: false,
          margin: {
              l: 140,   // left
              r: 140,   // right
              t: 190,  // top (increase this!)
              b: 60    // bottom
            }
        };

        Plotly.newPlot('regressionPlot', [regressionLine, ...points, ...residualSegments],
        layout, {staticPlot: true});
      })
      .catch(err => console.error("Error loading JSON:", err));
  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
    }
  </style>
</head>
<body>
  <div id="regressionPlot" style="width:1024px;height:768px;"></div>

  <script>
    // Load JSON file
    fetch("Entrega 1/popularidad.json")
      .then(response => response.json())
      .then(data => {
        // Nota: hay que desactivar la cache en "Network" en DevTools para que recargue el JSON
        console.log(data);
        // Extract variables
        const labels = data.map(d => d.genero);
        const x = data.map(d => d.proporcion);
        const y = data.map(d => d.popularidad);
        const r = data.map(d => d.residuos);

        const minVal = Math.min(...r);
        const maxVal = Math.max(...r);
        // f^-1 de f(x) = min + x * (max - min)
        const zeroPos = (0 - minVal) / (maxVal - minVal);

        // --- Traces ---

        // Regression line
        const lineX = [0, Math.max(...y)];
        const lineY = lineX;

        const regressionLine = {
          x: lineX,
          y: lineY,
          mode: 'lines',
          type: 'scatter',
          name: 'Regression Line',
          line: { color: 'black' }
        };

        // Residual lollipops (vertical segments)
        function colorScale(val, minVal, maxVal, zeroPos) {
          const t = (val - minVal) / (maxVal - minVal); // normalize 0..1
          if (t <= zeroPos) {
            // interpolate red → gray
            const alpha = t / zeroPos;
            return `rgb(${255 * (1 - alpha) + 128 * alpha},${0 + 128 * alpha},${0 + 128 * alpha})`;
          } else {
            // interpolate gray → blue
            const alpha = (t - zeroPos) / (1 - zeroPos);
            return `rgb(${128 * (1 - alpha)},${128 * (1 - alpha)},${128 + 127 * alpha})`;
          }
        }

        // Scatter points
        const points = x.map((d,i) => {
          // Format label with residual percentage
          const label = `${labels[i]}<br>${r[i].toFixed(3)*100}%`;

          // Pick position depending on residual
          let pos;
          if (r[i] > 1) {
            pos = 'top center';
          } else if (r[i] < -1) {
            pos = 'bottom center';
          } else {
            pos = 'bottom right';
          }

          let mode_spec;
          if (Math.abs(r[i]) > 0.09) {
            mode_spec = 'markers+text';
          } else {
            mode_spec = 'markers';
          }

          return {
            x: [x[i]],
            y: [y[i]],
            text: [label],
            mode: mode_spec,
            type: 'scatter',
            name: 'Observed',
            textposition: pos,
            marker: {
              size: 5 + Math.abs(r[i]) / 2,
              color: colorScale(r[i], minVal, maxVal, zeroPos)
            },
            textfont: {
              family: '<b>Roboto</b>', // bold-ish font
              size: 12,                          // font size in px
              color: colorScale(r[i], minVal, maxVal, zeroPos)
            },
            showlegend: false // avoid repeating "Observed" in legend
          };
        });

        // const diagonalLabels = x.map((d,i) => {
        //   // Format label with residual percentage
        //   const label = `${x[i].toFixed(1)}%`;

        //   // Pick position depending on residual
        //   let pos;
        //   if (r[i] > 1) {
        //     pos = 'bottom center';
        //   } else if (r[i] < -1) {
        //     pos = 'top center';
        //   } else {
        //     pos = 'right';
        //   }

        //   return {
        //     x: [x[i]],
        //     y: [x[i]],
        //     text: [label],
        //     mode: 'text',
        //     name: 'Observed',
        //     textposition: pos,
        //     showlegend: false,
        //     hoverinfo: 'skip',         // don’t clutter hover
        //     textfont: {
        //       family: 'Roboto', // bold-ish font
        //       size: 9,                          // font size in px
        //       color: 'Black'                  // text color
        //     },
        //   };
        // });

        // Generate one trace per residual
        const residualSegments = x.map((d,i) => ({
          x: [x[i], x[i]],
          y: [y[i], x[i]], // start at actual y, end at fitted value
          mode: 'lines',
          type: 'scatter',
          line: {
            width: 2,
            color: colorScale(r[i], minVal, maxVal, zeroPos)
          },
          showlegend: false,
          hoverinfo: 'skip'
        }));

        const layout = {
          title: "Supply vs Market Share with Regression Residuals",
          xaxis: {
            showgrid: false,
            tickformat: ',.0%',
          },
          yaxis: {
            showgrid: false,
            tickformat: ',.0%',
          },
          annotations: [
            {
              text: 'This is a subtitle',
              xref: 'paper',
              yref: 'paper',
              x: 0.5,     // center horizontally
              y: 1.05,    // slightly below the title
              showarrow: false,
              font: {size: 16, color: 'gray'}
            },
            {
              text: "Top-left region",
              xref: "paper",
              yref: "paper",
              x: 0.1,   // near left
              y: 0.9,   // near top
              showarrow: false,
              font: { size: 18, color: "blue" }
            },
            {
              text: "Bottom-right region",
              xref: "paper",
              yref: "paper",
              x: 0.9,   // near right
              y: 0.1,   // near bottom
              showarrow: false,
              font: { size: 18, color: "red" }
            },
            {
              xref: "paper",
              yref: "paper",
              x: -0.08,
              y: 1.05,
              xanchor: "left",
              yanchor: "top",
              text: "<b>Salario anual de la mujer</b>",
              font: { family: "Arial", size: 14, color: "rgb(10,10,10)" },
              showarrow: false,
            },
            {
              xref: "paper",
              yref: "paper",
              x: 0,
              y: -0.05,
              xanchor: "left",
              yanchor: "top",
              text: "<b>Salario anual del hombre</b>",
              font: { family: "Arial", size: 14, color: "rgb(10,10,10)" },
              showarrow: false,
            },{
              x: 0.3,
              y: 0.31,
              text: "<b>Salario igual</b>",
              showarrow: false,
              textangle: -30,
              font: { size: 14 },
            },
          ],
          showlegend: false
        };

        Plotly.newPlot('regressionPlot', [regressionLine, ...points, ...residualSegments],
        layout, {staticPlot: true});
      })
      .catch(err => console.error("Error loading JSON:", err));
  </script>
</body>
</html>
